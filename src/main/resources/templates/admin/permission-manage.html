<!DOCTYPE html>
<html lang="zh-CN" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}">

<head>
    <title layout:fragment="title">æƒé™ç®¡ç†</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="max-w-7xl mx-auto px-6 py-8">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <span class="text-4xl mr-3">ğŸ”</span>
                        æƒé™ç®¡ç†
                    </h1>
                    <p class="text-gray-600 mt-2">ç®¡ç†ç³»ç»Ÿæƒé™å’Œèœå•é…ç½®</p>
                </div>
                <button onclick="showCreatePermissionModal()" 
                        class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105 shadow-lg">
                    <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    æ–°å¢æƒé™
                </button>
            </div>

            <!-- æƒé™æ ‘å½¢è¡¨æ ¼ -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
                    <h2 class="text-xl font-semibold flex items-center">
                        <span class="text-2xl mr-3">ğŸŒ³</span>
                        æƒé™æ ‘å½¢ç»“æ„
                    </h2>
                </div>
                
                <div class="p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full table-auto">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æƒé™åç§°</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æƒé™ç¼–ç </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æƒé™ç±»å‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è·¯å¾„</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">çŠ¶æ€</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ’åº</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="permissionTreeTable">
                                <!-- æƒé™æ ‘å½¢æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ›å»º/ç¼–è¾‘æƒé™æ¨¡æ€æ¡† -->
        <div id="permissionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-t-lg">
                        <h3 class="text-lg font-semibold" id="modalTitle">æ–°å¢æƒé™</h3>
                    </div>
                    <form id="permissionForm" class="p-6">
                        <input type="hidden" id="permissionId" name="id">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æƒé™åç§°</label>
                            <input type="text" id="permissionName" name="permissionName" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æƒé™ç¼–ç </label>
                            <input type="text" id="permissionCode" name="permissionCode" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æƒé™ç±»å‹</label>
                            <select id="permissionType" name="permissionType" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">èœå•</option>
                                <option value="2">æŒ‰é’®</option>
                                <option value="3">API</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">çˆ¶æƒé™</label>
                            <select id="parentId" name="parentId"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="0">æ ¹æƒé™</option>
                                <!-- çˆ¶æƒé™é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æƒé™è·¯å¾„</label>
                            <input type="text" id="path" name="path"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æè¿°</label>
                            <textarea id="description" name="description" rows="3"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ’åº</label>
                            <input type="number" id="sortOrder" name="sortOrder" value="0"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-6">
                            <label class="flex items-center">
                                <input type="checkbox" id="status" name="status" checked
                                       class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-700">å¯ç”¨</span>
                            </label>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="hidePermissionModal()"
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                å–æ¶ˆ
                            </button>
                            <button type="submit"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                ä¿å­˜
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script layout:fragment="scripts">
        // æƒé™æ•°æ®
        const permissionTree = /*[[${permissionTree}]]*/ [];
        const allPermissions = /*[[${permissions}]]*/ [];
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderPermissionTree();
            loadParentOptions();
        });
        
        // æ¸²æŸ“æƒé™æ ‘å½¢è¡¨æ ¼
        function renderPermissionTree() {
            const tbody = document.getElementById('permissionTreeTable');
            tbody.innerHTML = '';
            
            function renderNode(node, level = 0) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const indent = '&nbsp;'.repeat(level * 4);
                const typeIcon = getTypeIcon(node.permissionType);
                const statusBadge = getStatusBadge(node.status);
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            ${indent}${typeIcon}
                            <span class="ml-2 text-sm font-medium text-gray-900">${node.permissionName}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${node.permissionCode}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${node.permissionTypeName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${node.path || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${node.sortOrder}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editPermission(${node.id})" class="text-blue-600 hover:text-blue-900 mr-3">ç¼–è¾‘</button>
                        <button onclick="deletePermission(${node.id})" class="text-red-600 hover:text-red-900">åˆ é™¤</button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // é€’å½’æ¸²æŸ“å­èŠ‚ç‚¹
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => renderNode(child, level + 1));
                }
            }
            
            permissionTree.forEach(node => renderNode(node));
        }
        
        // è·å–ç±»å‹å›¾æ ‡
        function getTypeIcon(type) {
            switch(type) {
                case 1: return '<span class="text-blue-500">ğŸ“</span>';
                case 2: return '<span class="text-green-500">ğŸ”˜</span>';
                case 3: return '<span class="text-purple-500">ğŸ”—</span>';
                default: return '<span class="text-gray-500">â“</span>';
            }
        }
        
        // è·å–çŠ¶æ€å¾½ç« 
        function getStatusBadge(status) {
            if (status === 1) {
                return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">å¯ç”¨</span>';
            } else {
                return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">ç¦ç”¨</span>';
            }
        }
        
        // åŠ è½½çˆ¶æƒé™é€‰é¡¹
        function loadParentOptions() {
            const parentSelect = document.getElementById('parentId');
            parentSelect.innerHTML = '<option value="0">æ ¹æƒé™</option>';
            
            function addOption(node, level = 0) {
                if (node.permissionType === 1) { // åªæœ‰èœå•ç±»å‹å¯ä»¥ä½œä¸ºçˆ¶æƒé™
                    const indent = 'ã€€'.repeat(level);
                    const option = document.createElement('option');
                    option.value = node.id;
                    option.textContent = indent + node.permissionName;
                    parentSelect.appendChild(option);
                }
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => addOption(child, level + 1));
                }
            }
            
            permissionTree.forEach(node => addOption(node));
        }
        
        // æ˜¾ç¤ºåˆ›å»ºæƒé™æ¨¡æ€æ¡†
        function showCreatePermissionModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢æƒé™';
            document.getElementById('permissionForm').reset();
            document.getElementById('permissionId').value = '';
            document.getElementById('status').checked = true;
            document.getElementById('permissionModal').classList.remove('hidden');
        }
        
        // éšè—æƒé™æ¨¡æ€æ¡†
        function hidePermissionModal() {
            document.getElementById('permissionModal').classList.add('hidden');
        }
        
        // ç¼–è¾‘æƒé™
        function editPermission(id) {
            const permission = findPermissionById(id);
            if (!permission) return;
            
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æƒé™';
            document.getElementById('permissionId').value = permission.id;
            document.getElementById('permissionName').value = permission.permissionName;
            document.getElementById('permissionCode').value = permission.permissionCode;
            document.getElementById('permissionType').value = permission.permissionType;
            document.getElementById('parentId').value = permission.parentId;
            document.getElementById('path').value = permission.path || '';
            document.getElementById('description').value = permission.description || '';
            document.getElementById('sortOrder').value = permission.sortOrder;
            document.getElementById('status').checked = permission.status === 1;
            
            document.getElementById('permissionModal').classList.remove('hidden');
        }
        
        // æŸ¥æ‰¾æƒé™
        function findPermissionById(id) {
            function search(nodes) {
                for (let node of nodes) {
                    if (node.id === id) return node;
                    if (node.children) {
                        const found = search(node.children);
                        if (found) return found;
                    }
                }
                return null;
            }
            return search(permissionTree);
        }
        
        // åˆ é™¤æƒé™
        function deletePermission(id) {
            const permission = findPermissionById(id);
            if (!permission) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤æƒé™"${permission.permissionName}"å—ï¼Ÿ`)) {
                fetch(`/api/admin/permissions/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('æƒé™åˆ é™¤æˆåŠŸ');
                        location.reload();
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('åˆ é™¤å¤±è´¥');
                });
            }
        }
        
        // æäº¤æƒé™è¡¨å•
        document.getElementById('permissionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {
                permissionName: formData.get('permissionName'),
                permissionCode: formData.get('permissionCode'),
                permissionType: parseInt(formData.get('permissionType')),
                parentId: parseInt(formData.get('parentId')),
                path: formData.get('path'),
                description: formData.get('description'),
                sortOrder: parseInt(formData.get('sortOrder')),
                status: document.getElementById('status').checked ? 1 : 0
            };
            
            const id = document.getElementById('permissionId').value;
            const url = id ? `/api/admin/permissions/${id}` : '/api/admin/permissions';
            const method = id ? 'PUT' : 'POST';
            
            if (id) {
                data.id = parseInt(id);
            }
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(id ? 'æƒé™æ›´æ–°æˆåŠŸ' : 'æƒé™åˆ›å»ºæˆåŠŸ');
                    hidePermissionModal();
                    location.reload();
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('æ“ä½œå¤±è´¥');
            });
        });
    </script>
</body>
</html>
